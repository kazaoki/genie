#!/usr/bin/env node
parcelRequire=function(e,r,n){var t="function"==typeof parcelRequire&&parcelRequire,i="function"==typeof require&&require;function u(n,o){if(!r[n]){if(!e[n]){var f="function"==typeof parcelRequire&&parcelRequire;if(!o&&f)return f(n,!0);if(t)return t(n,!0);if(i&&"string"==typeof n)return i(n);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}a.resolve=function(r){return e[n][1][r]||r};var l=r[n]=new u.Module(n);e[n][0].call(l.exports,a,l,l.exports)}return r[n].exports;function a(e){return u(a.resolve(e))}}u.isParcelRequire=!0,u.Module=function(e){this.id=e,this.bundle=u,this.exports={}},u.modules=e,u.cache=r,u.parent=t;for(var o=0;o<n.length;o++)u(n[o]);return u}({3:[function(require,module,exports) {
"use strict";function e(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function o(s,n){try{var p=t[s](n),l=p.value}catch(e){return void r(e)}if(!p.done)return Promise.resolve(l).then(function(e){o("next",e)},function(e){o("throw",e)});e(l)}("next")})}}const t=require("fs"),r=require("string-width"),o=require("cli-color"),s=require("jp-wrap")(o.windowSize.width-8),n=require("readline").createInterface(process.stdin,process.stdout),p=require("child_process"),l=require("path"),i=require("util"),c=module.exports.d=(e=>console.log(i.inspect(e,{colors:!0,compact:!1,breakLength:10,depth:10}))),a=module.exports.h=((e,t=o.white)=>console.log("\n  "+t(e))),u=module.exports.getProjectRootDir=(()=>{let e="",r=__dirname,o=!0;do{try{t.accessSync(r+"/.genie"),e=r}catch(e){r===(r=l.dirname(r))&&(o=!1)}}while(""===e&&o);if(e)return e;k("先祖ディレクトリに .genie/ が見つかりませんでした。\n`genie init` などして初期化してください。")}),h=module.exports.Repeat=((e,t=1)=>{if(!t>0)return"";let r="";for(let o=0;o<t;o++)r+=e;return r}),d=module.exports.Message=((e,t="default",n=0)=>{let p=o.white,l=o.white;"primary"===t?(p=o.xterm(26),l=o.xterm(39)):"success"===t?(p=o.green,l=o.greenBright):"danger"===t?(p=o.red,l=o.redBright):"warning"===t?(p=o.yellow,l=o.yellowBright):"info"===t&&(p=o.whiteBright,l=o.whiteBright);let i=(e=s(e.replace(/[\r\n]+$/,""))).split(/[\r\n]+/),c=0;for(let e in i){let t=r(i[e]);c<t&&(c=t)}c+=2,console.log("  "+p("┏")+p(h("─",c))+p("┓"));for(let e in i)n>0&&n==e&&console.log("  "+p("┣")+p(h("─",c))+p("┫")),console.log("  "+p("│")+l(" "+i[e]+" ")+h(" ",c-2-r(i[e]))+p("│"));console.log("  "+p("┗")+p(h("─",c))+p("┛"))}),g=module.exports.Messages=(e=>{Array.isArray(e)||(e=[e]);for(let t in e)for(let r in e[t])d(e[t][r],r)}),m=module.exports.Input=((e,t=20)=>{let s=o.bgBlack("  "),p=r(e="  "+e+"  ")+t,l=o.whiteBright.bgBlueBright,i=o.bgBlue;return console.log("\n"+s+l(h(" ",p))+"\n"+s+l(e+h(" ",t))+"\n"+s+l(h(" ",p))+"\n"+s+i(h(" ",p))),process.stdout.write(o.move.up(3)),process.stdout.write(o.move.right(p-t)),new Promise(e=>{n.on("line",t=>{process.stdout.write(o.move.down(3)),e(t)})})}),_=module.exports.Say=(e=>{if(0!==e.length)if(w())p.execSync(`say -r 300 "${e}"`);else if(S()){let r=t.mkdtempSync(process.env.TEMP+"/genie-say-"),o=r+"/say.js";t.writeFileSync(o,"var args = [];for(var i = 0; i < WScript.Arguments.length; i++) args.push(WScript.Arguments.Item(i));WScript.CreateObject('SAPI.SpVoice').Speak('<volume level=\"100\">'+'<rate speed=\"2\">'+'<pitch middle=\"0\">'+args.join(' ')+'</pitch>'+'</rate>'+'</volume>', 8);"),p.execSync(`start wscript ${o} "${e}"`),t.unlinkSync(o),t.rmdirSync(r)}}),y=module.exports.loadConfig=(e=>{let r=`${u()}/.genie/${e.config}`;try{t.accessSync(r)}catch(t){k(`設定ファイル（.genie/${e.config}）が見つかりませんでした。`)}let o=require(r).config;return o.runmode=e.mode,o}),S=module.exports.isWindows=(()=>"win32"===process.platform),w=module.exports.isMac=(()=>"darwin"===process.platform),$=module.exports.hasDockerMachineEnv=(()=>{return 0===p.spawnSync("docker-machine").status}),k=module.exports.Error=(e=>{console.log(),d(`エラーが発生しました。\n${e}`,"danger",1),_("エラーが発生しました"),process.exit()}),f=module.exports.dockerDown=((t,r)=>new Promise((s,n)=>{let l=x(r,t),i=[];for(let e=0;e<l.length;e++)i.push(new Promise((t,r)=>{process.stdout.write(o.blackBright(`  ${l[e].name} (${l[e].id}) ...`));let s=p.spawnSync("docker",["rm","-f",l[e].id]);s.stderr.toString()?(process.stdout.write(o.red(" delete NG!\n")),r(s.stderr.toString())):(process.stdout.write(o.green(" deleted.\n")),t())}));e(function*(){yield Promise.all(i).catch(function(e){return e})})(),s()})),b=module.exports.dockerUp=((e,t)=>"postgresql"===e?new Promise((e,r)=>{try{let o=Object.keys(t.db.postgresql);for(let s=0;s<o.length;s++){let n=t.db.postgresql[o[s]],l=[];l.push("run","-d","-it"),l.push("-e","TERM=xterm"),l.push("--name",`${t.up.base_name}-postgresql-${o[s]}`),l.push("--label",`genie_project_dir="${t.up.label.genie_project_dir}"`),t.up.label.genie_shadow&&l.push("--label","genie_shadow"),l.push("-v",`${t.up.label.genie_project_dir}/.genie/root/opt/postgresql/:/opt/postgresql/`),l.push("-e",`POSTGRES_LABEL=${o[s]}`),l.push("-e",`POSTGRES_HOST=${n.host}`),l.push("-e",`POSTGRES_DB=${n.name}`),l.push("-e",`POSTGRES_USER=${n.user}`),l.push("-e",`POSTGRES_PASSWORD=${n.pass}`),l.push("-e",`POSTGERS_ENCODING=${n.encoding}`),l.push("-e",`POSTGERS_LOCALE=${n.locale}`),t.core.docker.network&&l.push(`--net=${t.core.docker.network}`),t.core.docker.options&&l.push(`${t.core.docker.options}`),n.external_port&&l.push("-p",`${n.external_port}:5432`),l.push("--entrypoint=/opt/postgresql/before-entrypoint.sh"),l.push("--restart=always"),l.push(n.repository),l.push("postgres");let i=p.spawnSync("docker",l);i.stderr.toString()?r(i.stderr.toString()):e()}e()}catch(e){r(e)}}):"mysql"===e?new Promise((e,r)=>{try{let o=Object.keys(t.db.mysql);for(let s=0;s<o.length;s++){let n=t.db.mysql[o[s]],l=[];l.push("run","-d","-it"),l.push("-e","TERM=xterm"),l.push("--name",`${t.up.base_name}-mysql-${o[s]}`),l.push("--label",`genie_project_dir="${t.up.label.genie_project_dir}"`),t.up.label.genie_shadow&&l.push("--label","genie_shadow"),l.push("-v",`${t.up.label.genie_project_dir}/.genie/root/opt/mysql/:/opt/mysql/`),l.push("-e",`MYSQL_LABEL=${o[s]}`),l.push("-e",`MYSQL_ROOT_PASSWORD=${n.pass}`),l.push("-e",`MYSQL_DATABASE=${n.name}`),l.push("-e",`MYSQL_USER=${n.user}`),l.push("-e",`MYSQL_PASSWORD=${n.pass}`),l.push("-e",`MYSQL_CHARSET=${n.charset}`),t.core.docker.network&&l.push(`--net=${t.core.docker.network}`),t.core.docker.options&&l.push(`${t.core.docker.options}`),n.external_port&&l.push("-p",`${n.external_port}:3306`),l.push("--entrypoint=/opt/mysql/before-entrypoint.sh"),l.push("--restart=always"),l.push(n.repository),l.push("mysqld"),n.charset&&l.push(`--character-set-server=${n.charset}`),n.collation&&l.push(`--collation-server=${n.collation}`);let i=p.spawnSync("docker",l);i.stderr.toString()?r(i.stderr.toString()):e()}e()}catch(e){r(e)}}):"genie"===e?new Promise((e,r)=>{let o=[];if(o.push("run","-d","-it"),o.push("-e","TERM=xterm"),o.push("-e","LANG=ja_JP.UTF-8"),o.push("-e","LC_ALL=ja_JP.UTF-8"),o.push("-v",t.up.label.genie_project_dir+"/.genie/root/opt:/opt"),o.push("--label",`genie_project_dir="${t.up.label.genie_project_dir}"`),t.up.label.genie_shadow&&o.push("--label","genie_shadow"),o.push(`--name=${t.up.base_name}`),t.core.docker.network&&o.push(`--net=${t.core.docker.network}`),t.core.docker.options&&o.push(`${t.core.docker.options}`),o.push("--restart=always"),t.lang.perl.cpanfile_enabled&&o.push("-e","PERL5LIB=/perl/cpanfile-modules/lib/perl5"),t.db.postgresql){let e=Object.keys(t.db.postgresql);for(let r=0;r<e.length;r++){let s=`${t.up.base_name}-postgresql-${e[r]}`;o.push("--link",s),o.push("--add-host",t.db.postgresql[e[r]].host+":"+v(s,t))}}if(t.db.mysql){let e=Object.keys(t.db.mysql);for(let r=0;r<e.length;r++){let s=`${t.up.base_name}-mysql-${e[r]}`;o.push("--link",s),o.push("--add-host",t.db.mysql[e[r]].host+":"+v(s,t))}}if(t.trans.sshd&&o.push("-p",`${t.trans.sshd.external_port}:22`),t.http.apache&&(o.push("-v",`${t.up.label.genie_project_dir}/${t.http.apache.public_dir}:/var/www/html`),t.http.apache.external_http_port&&o.push("-p",`${t.http.apache.external_http_port}:80`),t.http.apache.external_https_port&&o.push("-p",`${t.http.apache.external_https_port}:443`)),t.http.nginx&&(o.push("-v",`${t.up.label.genie_project_dir}/${t.http.nginx.public_dir}:/usr/share/nginx/html`),t.http.nginx.external_http_port&&o.push("-p",`${t.http.nginx.external_http_port}:80`),t.http.nginx.external_https_port&&o.push("-p",`${t.http.nginx.external_https_port}:443`)),t.mail.sendlog.external_port&&o.push("-p",`${t.mail.sendlog.external_port}:9981`),t.log.fluentd&&o.push("-v",`${t.up.label.genie_project_dir}/.genie/root/opt/td-agent:/etc/td-agent`),t.core.docker.hosts&&Array.isArray(t.core.docker.hosts)&&t.core.docker.hosts.length)for(let e=0;e<t.core.docker.hosts.length;e++)o.push(`--add-host=${t.core.docker.hosts[e]}`);if(o.push("-v",`${t.up.label.genie_project_dir}/:/mnt/host/`),t.core.docker.volumes&&Array.isArray(t.core.docker.volumes)&&t.core.docker.volumes.length)for(let e=0;e<t.core.docker.volumes.length;e++)t.core.docker.volumes[e].match(/^\//)?o.push("-v",`${t.core.docker.volumes[e]}`):o.push("-v",`${t.up.label.genie_project_dir}/${t.core.docker.volumes[e]}`);let s={},n=(e,t)=>{if("object"!=typeof e||Array.isArray(e))"object"==typeof e&&Array.isArray(e)?s[t]=JSON.stringify(e):s[t]=e;else{let r=Object.keys(e);for(let o=0;o<r.length;o++)n(e[r[o]],`${t}_${r[o].toUpperCase()}`)}};n(t,"GENIE"),s.GENIE_RUNMODE=t.runmode;let l=Object.keys(s);for(let e=0;e<l.length;e++);o.push(t.core.docker.image),c(o);let i=p.spawnSync("docker",o);i.stderr.toString()?r(i.stderr.toString()):e()}):void 0),x=module.exports.existContainers=((e,t)=>{let r=["--filter",`label=genie_project_dir="${e.up.label.genie_project_dir}"`];e.up.label.genie_shadow&&r.push("--filter","label=genie_shadow"),t&&r.push("--filter",`name=${t}`);let o=p.spawnSync("docker",["ps","-a","--format","{{.ID}}\t{{.Names}}",...r]).stdout.toString().split(/\n/),s=[];for(let e=0;e<o.length;e++){let t=o[e].split(/\s+/);t[0]&&s.push({id:t[0],name:t[1]})}return!!s.length&&s}),v=module.exports.getContainerIp=((e,t)=>{try{let r;if(!(r=t.core.docker.network?p.spawnSync("docker",["inspect",`--format={{.NetworkSettings.Networks.${t.core.docker.network}.IPAddress}}`,e]):p.spawnSync("docker",["inspect","--format={{.NetworkSettings.IPAddress}}",e])).stderr.toString())return r.stdout.toString().replace(/[\r\n]$/,"");k(r.stderr.toString())}catch(e){k(e)}});
},{}],1:[function(require,module,exports) {
"use strict";function e(e){return function(){var o=e.apply(this,arguments);return new Promise(function(e,n){return function s(t,i){try{var r=o[t](i),a=r.value}catch(e){return void n(e)}if(!r.done)return Promise.resolve(a).then(function(e){s("next",e)},function(e){s("throw",e)});e(a)}("next")})}}const o=require("optimist"),n=require("cli-color"),s=require("child_process"),t=require("cliui")(),i=require("./libs.js"),r=i.d,a=i.h;let l=o.usage("Usage: genie|g [Commands] [Options]").options("mode",{alias:"m",default:"develop",describe:"実行モードを指定可能"}).options("config",{alias:"c",default:"config.js",describe:"設定ファイルを指定可能"}).options("help",{alias:"h",describe:"説明表示"}).argv;if("demo"===l._[0])e(function*(){console.log(),i.Message("サンプル：default","default"),i.Message("サンプル：primary","primary"),i.Message("サンプル：success","success"),i.Message("サンプル：danger","danger"),i.Message("サンプル：warning","warning"),i.Message("サンプル：info","info"),i.Message("改行込み、1ライン入れも可能。\ntest1\ntest2\ntest3","default",1);let e=yield i.Input("入力BOX（入力文字を発音しますのでご注意）：",20);i.Message("入力された文字："+e),i.Say(e);try{throw new Error("エラーテスト（終了コード255）")}catch(e){console.log(e),process.exit(255)}process.exit()})();else if("ls"===l._[0]){let e=o.usage("Usage: genie|g ls [Options]").options("long",{alias:"l",describe:"コンテナ一覧がもうちょっとだけ詳細に出ます"}).argv;if(e.help&&(o.showHelp(),process.exit()),i.hasDockerMachineEnv()){console.log("\n  DockerMachine一覧");let e=s.spawnSync("docker-machine",["ls"]);i.Message(e.stdout.toString(),"primary",1)}{console.log("\n  イメージ一覧");let e=s.spawnSync("docker",["images"]);i.Message(e.stdout.toString(),"primary",1)}{console.log("\n  データボリューム一覧");let e=s.spawnSync("docker",["volume","ls"]);i.Message(e.stdout.toString(),"primary",1)}{console.log("\n  コンテナ一覧");let o=["--format","{{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}\t{{.Names}}"],n=["ID","IMAGE","STATUS","PORTS","NAMES"];e.long&&(o=["--format","{{.ID}}\t{{.Image}}\t{{.Command}}\t{{.CreatedAt}}\t{{.Status}}\t{{.Ports}}\t{{.Names}}\t{{.Labels}}"],n=["ID","IMAGE","COMMAND","CREATED AT","STATUS","PORTS","NAMES","LABELS"]);let r=s.spawnSync("docker",["ps","-a",...o]).stdout.toString().replace(/[\r\n]$/,"").split("\n");e.long?r.unshift("CONTAINER ID\tIMAGE\tCOMMAND\tCREATED AT\tSTATUS\tPORTS\tNAMES\tLABELS"):r.unshift("CONTAINER ID\tIMAGE\tSTATUS\tPORTS\tNAMES");for(let o in r){let n=r[o].split(/\t/),s=[];for(let o in n){let t;e.long?(0==o&&(t=15),5==o&&(t=30),6==o&&(t=40),7==o&&(t=90)):(0==o&&(t=15),3==o&&(t=30),4==o&&(t=40)),s.push({text:n[o].replace(/, ?/g,"\n"),width:t,padding:[0,1,0,1]})}t.div(...s)}i.Message(t.toString(),"primary",1)}process.exit()}else if("config"===l._[0]){let e=o.usage("Usage: genie|g config [Options]").options("dump",{alias:"d",describe:"設定値を確認します。"}).argv;if(e.help)o.showHelp();else{let o=i.loadConfig(e);if(e.dump)r(o);else{let o=`${i.getProjectRootDir()}/.genie/${e.config}`;i.isWindows()?s.execSync(`start ${o}`):i.isMac()&&s.execSync(`open ${o}`)}}process.exit()}else if("clean"===l._[0]){o.usage("Usage: genie|g clean [Options]").options("locked",{alias:"l",describe:"`locked`を含むDataVolumeも削除"}).argv.help&&o.showHelp(),process.exit()}else if("langver"===l._[0]){let e=o.usage("Usage: genie|g langver [Options]").options("php",{describe:"PHPの利用可能なバージョン一覧を表示"}).options("perl",{describe:"Perlの利用可能なバージョン一覧を表示"}).options("ruby",{describe:"Rubyの利用可能なバージョン一覧を表示"}).options("node",{describe:"Node.jsの利用可能なバージョン一覧を表示"}).argv;if(e.help)o.showHelp();else if(e.php){let e=s.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/phpenv/plugins/php-build/bin/php-build --definitions"]);i.Message(e.stdout.toString(),"primary")}else if(e.perl){let e=s.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/plenv/plugins/perl-build/perl-build  --definitions"]);i.Message(e.stdout.toString(),"primary")}else if(e.ruby){let e=s.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/rbenv/plugins/ruby-build/bin/ruby-build  --definitions"]);i.Message(e.stdout.toString(),"primary")}else if(e.node){let e=s.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/ndenv/plugins/node-build/bin/node-build  --definitions"]);i.Message(e.stdout.toString(),"primary")}else o.showHelp();process.exit()}else if("up"===l._[0]){let n=o.usage("Usage: genie|g up [Options]").options("shadow",{alias:"s",describe:"データをマウントではなくコンテナにコピーした別のコンテナを起動する"}).argv;n.help&&o.showHelp();let s=i.loadConfig(n);s.up={},s.up.base_name=n.shadow?s.core.docker.name+"-SHADOW":s.core.docker.name,s.up.label={genie_project_dir:i.getProjectRootDir()},n.shadow&&(s.up.label.genie_shadow=1);try{let e=s.core.memo.up;e&&i.Messages(e)}catch(e){Error("メモの設定が異常です。")}e(function*(){i.existContainers(s)&&(yield Promise.all([i.dockerDown("/"+s.up.base_name+"-postgresql",s),i.dockerDown("/"+s.up.base_name+"-mysql",s),i.dockerDown("/"+s.up.base_name+"$",s),i.dockerDown(null,s)]).catch(function(e){return e}));let e=[];try{Object.keys(s.db.postgresql).length&&e.push(i.dockerUp("postgresql",s))}catch(e){Error(e)}try{Object.keys(s.db.mysql).length&&e.push(i.dockerUp("mysql",s))}catch(e){Error(e)}yield Promise.all(e).catch(function(e){i.Error(e)}),yield i.dockerUp("genie",s).catch(function(e){return i.Error(e)}),a("起動完了!!"),process.exit()})()}else if("down"===l._[0]){let n=o.usage("Usage: genie|g down [Options]").options("shadow",{alias:"s",describe:"データをマウントではなくコンテナにコピーした別のコンテナを終了する"}).argv;n.help&&o.showHelp();let s=i.loadConfig(n);s.up={},s.up.base_name=n.shadow?s.core.docker.name+"-SHADOW":s.core.docker.name,s.up.label={genie_project_dir:i.getProjectRootDir()},n.shadow&&(s.up.label.genie_shadow=1);try{let e=s.core.memo.down;e&&i.Messages(e)}catch(e){Error("メモの設定が異常です。")}e(function*(){i.existContainers(s)&&(yield Promise.all([i.dockerDown("/"+s.up.base_name+"-postgresql",s),i.dockerDown("/"+s.up.base_name+"-mysql",s),i.dockerDown("/"+s.up.base_name+"$",s),i.dockerDown(null,s)]).catch(function(e){return e})),a("DONE!"),process.exit()})()}else if("build"===l._[0]){let t=o.usage("Usage: genie|g build [Options]").options("no-cache",{alias:"n",describe:"キャッシュを使用せずにビルドする"}).argv;t.help&&o.showHelp();let r=i.loadConfig(t);e(function*(){if((yield i.Input(`${r.core.docker.image} イメージをビルドしてもよろしいでしょうか。[y/N]: `)).match(/^y$/i)){let e=["build","-t",r.core.docker.image];t["no-cache"]&&e.push("--no-cache"),e.push(`${i.getProjectRootDir()}/.genie/image/`),i.Message(`ビルドを開始します。\ndocker ${e.join(" ")}`,"info"),console.log();let o=s.spawn("docker",e);o.stdout.on("data",function(e){console.log(n.blackBright(e.toString().replace(/[\r\n]+$/,"")))}),o.stderr.on("data",function(e){i.Error(e),process.exit()}),o.on("close",function(e){let o="イメージのビルドが正常に完了しました。";i.Message(o),i.Say(o),process.exit()})}})()}else console.error(o.help()+"\nCommands:\n  init    \n  config  設定を確認する\n  ls      Dockerコンテナ状況を確認する\n  up      Dockerコンテナを起動する\n  down    \n  update  \n  cli     \n  reject  \n  clean   \n  build   基本のdockerイメージをビルドする\n  langver 各種言語の利用可能なバージョンを確認する\n  mysql   \n  psql    \n  open    \n  ngrok   \n  logs    \n  dlsync  \n  httpd   \n  demo    デモ\n"),process.exit();
},{"./libs.js":3}]},{},[1])