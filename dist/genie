#!/usr/bin/env node
parcelRequire=function(e,r,n){var t="function"==typeof parcelRequire&&parcelRequire,i="function"==typeof require&&require;function u(n,o){if(!r[n]){if(!e[n]){var f="function"==typeof parcelRequire&&parcelRequire;if(!o&&f)return f(n,!0);if(t)return t(n,!0);if(i&&"string"==typeof n)return i(n);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}a.resolve=function(r){return e[n][1][r]||r};var l=r[n]=new u.Module(n);e[n][0].call(l.exports,a,l,l.exports)}return r[n].exports;function a(e){return u(a.resolve(e))}}u.isParcelRequire=!0,u.Module=function(e){this.id=e,this.bundle=u,this.exports={}},u.modules=e,u.cache=r,u.parent=t;for(var o=0;o<n.length;o++)u(n[o]);return u}({3:[function(require,module,exports) {
"use strict";const fs=require("fs"),strwidth=require("string-width"),color=require("cli-color"),wrap=require("jp-wrap")(color.windowSize.width-8),child=require("child_process"),path=require("path"),util=require("util"),d=module.exports.d=(e=>console.log(util.inspect(e,{colors:!0,compact:!1,breakLength:10,depth:10}))),h=module.exports.h=((e,o=color.white)=>console.log("\n  "+o(e))),getRootDir=module.exports.getRootDir=(()=>{let e="",o=__dirname,r=!0;do{try{fs.accessSync(o+"/.genie"),e=o}catch(e){o===(o=path.dirname(o))&&(r=!1)}}while(""===e&&r);if(e)return e;Error("先祖ディレクトリに .genie/ が見つかりませんでした。\n`genie init` などして初期化してください。")}),Repeat=module.exports.Repeat=((e,o=1)=>{if(!o>0)return"";let r="";for(let t=0;t<o;t++)r+=e;return r}),Message=module.exports.Message=((e,o="default",r=0)=>{let t=color.white,s=color.white;"primary"===o?(t=color.xterm(26),s=color.xterm(39)):"success"===o?(t=color.green,s=color.greenBright):"danger"===o?(t=color.red,s=color.redBright):"warning"===o?(t=color.yellow,s=color.yellowBright):"info"===o?(t=color.whiteBright,s=color.whiteBright):"whisper"===o&&(t=color.blackBright,s=color.blackBright);let n=(e=wrap(e.replace(/[\r\n]+$/,""))).split(/[\r\n]+/),l=0;for(let e in n){let o=strwidth(n[e]);l<o&&(l=o)}l+=2,console.log("  "+t("┏")+t(Repeat("─",l))+t("┓"));for(let e in n)r>0&&r==e&&console.log("  "+t("┣")+t(Repeat("─",l))+t("┫")),console.log("  "+t("│")+s(" "+n[e]+" ")+Repeat(" ",l-2-strwidth(n[e]))+t("│"));console.log("  "+t("┗")+t(Repeat("─",l))+t("┛"))}),Messages=module.exports.Messages=(e=>{Array.isArray(e)||(e=[e]);for(let o in e)for(let r in e[o])Message(e[o][r],r)}),Input=module.exports.Input=((e,o=20)=>{const r=require("readline").createInterface(process.stdin,process.stdout);let t=color.bgBlack("  "),s=strwidth(e="  "+e+"  ")+o,n=color.whiteBright.bgBlueBright,l=color.bgBlue;return process.stdout.write("\n"+t+n(Repeat(" ",s))+"\n"+t+n(e+Repeat(" ",o))+"\n"+t+n(Repeat(" ",s))+"\n"+t+l(Repeat(" ",s))+"\n"),process.stdout.write(color.move.up(3)),process.stdout.write(color.move.right(s-o)),new Promise(e=>{r.on("line",o=>{process.stdout.write(color.move.down(3)),r.close(),e(o)})})}),Say=module.exports.Say=(e=>{if(0!==e.length)if(isMac())child.execSync(`say -r 300 "${e}"`);else if(isWindows()){let o=fs.mkdtempSync(process.env.TEMP+"/genie-say-"),r=o+"/say.js";fs.writeFileSync(r,"var args = [];for(var i = 0; i < WScript.Arguments.length; i++) args.push(WScript.Arguments.Item(i));WScript.CreateObject('SAPI.SpVoice').Speak('<volume level=\"100\">'+'<rate speed=\"2\">'+'<pitch middle=\"0\">'+args.join(' ')+'</pitch>'+'</rate>'+'</volume>', 8);"),child.execSync(`start wscript ${r} "${e}"`),fs.unlinkSync(r),fs.rmdirSync(o)}}),showRunmode=module.exports.showRunmode=(e=>{console.log(color.blackBright(`<${process.env.GENIE_RUNMODE}>`))}),loadConfig=module.exports.loadConfig=(argv=>{let root_dir=getRootDir(),config_js=`${root_dir}/.genie/${argv.config}`;try{fs.accessSync(config_js)}catch(e){Error(`設定ファイル（.genie/${argv.config}）が見つかりませんでした。`)}delete require.cache[require.resolve(config_js)];let config=require(config_js).config;config.runmode=argv.mode,config.root=getRootDir();let paths=path.parse(config_js),add_config_js;add_config_js=path.isAbsolute(config_js)?`${paths.dir}/${paths.name}-${config.runmode}${paths.ext}`:`${root_dir}/.genie/${paths.dir}/${paths.name}-${config.runmode}${paths.ext}`;try{fs.accessSync(add_config_js),eval(fs.readFileSync(add_config_js).toString())}catch(e){}if(config.base_name=config.core.docker.name,!config.core.docker.machine&&process.env.DOCKER_MACHINE_NAME&&(config.core.docker.machine=process.env.DOCKER_MACHINE_NAME),config.core.docker.ip_force)config.host_ip=config.core.docker.ip_force;else if(hasDockerMachineEnv()&&config.core.docker.machine){let e=child.spawnSync("docker-machine",["ip",config.core.docker.machine]);e.status&&Error(e.stderr.toString()),config.host_ip=e.stdout.toString().trim()}else config.host_ip="localhost";return config}),isWindows=module.exports.isWindows=(()=>"win32"===process.platform),isMac=module.exports.isMac=(()=>"darwin"===process.platform),hasDockerMachineEnv=module.exports.hasDockerMachineEnv=(()=>{return 0===child.spawnSync("docker-machine").status}),Error=module.exports.Error=(e=>{console.log(),Message(`エラーが発生しました。\n${e}`,"danger",1),Say("エラーが発生しました"),process.exit()}),dockerDown=module.exports.dockerDown=((e,o)=>new Promise((r,t)=>{let s=existContainers(e);s||r();let n=[];var l=!0,c=!1,a=void 0;try{for(var i,p=s[Symbol.iterator]();!(l=(i=p.next()).done);l=!0){let e=i.value;n.push(new Promise((o,r)=>{child.spawn("docker",["rm","-f",e.id]).stderr.on("data",o=>{console.log(color.blackBright(`  [Container] ${e.name} (${e.id}) ... `)+color.red("delete NG!")),r(o)}).on("close",r=>{console.log(color.blackBright(`  [Container] ${e.name} (${e.id}) ... `)+color.green("deleted")),o()})}))}}catch(e){c=!0,a=e}finally{try{!l&&p.return&&p.return()}finally{if(c)throw a}}Promise.all(n).catch(e=>{Error(e)}).then(()=>{if(e.core.docker.down_with_volumes||o){let o=[],a=new RegExp(`^(locked_)?${e.base_name}`),i=child.spawnSync("docker",["volume","ls","--format","{{.Name}}"]);i.status&&Error(i.stderr.toString());var t=!0,s=!1,n=void 0;try{for(var l,c=i.stdout.toString().trim().split(/\n/)[Symbol.iterator]();!(t=(l=c.next()).done);t=!0){let e=l.value;e.match(a)&&o.push(new Promise((o,r)=>{child.spawn("docker",["volume","rm","-f",e]).stderr.on("data",o=>{console.log(color.blackBright(`  [Volume] ${e} ... `)+color.red("delete NG!")),r(o)}).on("close",r=>{console.log(color.blackBright(`  [Volume] ${e} ... `)+color.green("deleted")),o()})}))}}catch(e){s=!0,n=e}finally{try{!t&&c.return&&c.return()}finally{if(s)throw n}}Promise.all(o).catch(e=>{Error(e)}).then(()=>{r()})}else r()})})),dockerUpMySQL=module.exports.dockerUpMySQL=((e,o)=>new Promise((r,t)=>{let s=o.db.mysql[e],n=`${o.base_name}-mysql-${e}`,l=[];l.push("run","-d","-it"),l.push("-e","TERM=xterm-256color"),l.push("--name",n),l.push("--label",`genie_runmode="${o.runmode}"`),l.push("--label",`genie_root="${o.root}"`),l.push("-v",`${o.root}/.genie/files/opt/mysql/:/opt/mysql/`),l.push("-v",`${s.volume_lock?"locked_":""}${n}:/var/lib/mysql`),l.push("-e",`MYSQL_LABEL=${e}`),l.push("-e",`MYSQL_ROOT_PASSWORD=${s.pass}`),l.push("-e",`MYSQL_DATABASE=${s.name}`),l.push("-e",`MYSQL_USER=${s.user}`),l.push("-e",`MYSQL_PASSWORD=${s.pass}`),l.push("-e",`MYSQL_CHARSET=${s.charset}`),o.core.docker.network&&l.push(`--net=${o.core.docker.network}`),o.core.docker.options&&l.push(`${o.core.docker.options}`),s.external_port&&l.push("-p","auto"===s.external_port?"3306":`${s.external_port}:3306`),l.push("--entrypoint=/opt/mysql/before-entrypoint.sh"),l.push("--restart=always"),l.push(s.repository),l.push("mysqld"),s.charset&&l.push(`--character-set-server=${s.charset}`),s.collation&&l.push(`--collation-server=${s.collation}`),child.spawn("docker",l).stderr.on("data",e=>{e.toString().match(/Unable to find image '.+' locally/)&&(process.env[`DOCKER_IMAGE_DOWN_LOADING_${n.toUpperCase()}`]=!0)}).on("close",e=>{delete process.env[`DOCKER_IMAGE_DOWN_LOADING_${n.toUpperCase()}`],r()})})),dockerUpPostgreSQL=module.exports.dockerUpPostgreSQL=((e,o)=>new Promise((r,t)=>{let s=o.db.postgresql[e],n=`${o.base_name}-postgresql-${e}`,l=[];l.push("run","-d","-it"),l.push("-e","TERM=xterm-256color"),l.push("--name",n),l.push("--label",`genie_runmode="${o.runmode}"`),l.push("--label",`genie_root="${o.root}"`),l.push("-v",`${o.root}/.genie/files/opt/postgresql/:/opt/postgresql/`),l.push("-v",`${s.volume_lock?"locked_":""}${n}:/var/lib/postgresql/data`),l.push("-e",`POSTGRES_LABEL=${e}`),l.push("-e",`POSTGRES_HOST=${s.host}`),l.push("-e",`POSTGRES_DB=${s.name}`),l.push("-e",`POSTGRES_USER=${s.user}`),l.push("-e",`POSTGRES_PASSWORD=${s.pass}`),l.push("-e",`POSTGERS_ENCODING=${s.encoding}`),l.push("-e",`POSTGERS_LOCALE=${s.locale}`),o.core.docker.network&&l.push(`--net=${o.core.docker.network}`),o.core.docker.options&&l.push(`${o.core.docker.options}`),s.external_port&&l.push("-p","auto"===s.external_port?"5432":`${s.external_port}:5432`),l.push("--entrypoint=/opt/postgresql/before-entrypoint.sh"),l.push("--restart=always"),l.push(s.repository),l.push("postgres"),child.spawn("docker",l).stderr.on("data",e=>{e.toString().match(/Unable to find image '.+' locally/)&&(process.env[`DOCKER_IMAGE_DOWN_LOADING_${n.toUpperCase()}`]=!0)}).on("close",e=>{delete process.env[`DOCKER_IMAGE_DOWN_LOADING_${n.toUpperCase()}`],r()})})),dockerUp=module.exports.dockerUp=(e=>new Promise((o,r)=>{let t=[];if(t.push("run","-d","-it"),t.push("-e","TERM=xterm-256color"),t.push("-e","LANG=ja_JP.UTF-8"),t.push("-e","LC_ALL=ja_JP.UTF-8"),t.push("-v",e.root+"/.genie/files/opt:/opt"),t.push("--label",`genie_runmode="${e.runmode}"`),t.push("--label",`genie_root="${e.root}"`),t.push(`--name=${e.base_name}`),e.core.docker.network&&t.push(`--net=${e.core.docker.network}`),e.core.docker.options&&t.push(`${e.core.docker.options}`),t.push("--restart=always"),e.lang.perl.cpanfile_enabled&&t.push("-e","PERL5LIB=/perl/cpanfile-modules/lib/perl5"),e.db.postgresql){let o=Object.keys(e.db.postgresql);for(let r=0;r<o.length;r++){let s=`${e.base_name}-postgresql-${o[r]}`;t.push("--link",s),t.push("--add-host",e.db.postgresql[o[r]].host+":"+getContainerIp(s,e))}}if(e.db.mysql){let o=Object.keys(e.db.mysql);for(let r=0;r<o.length;r++){let s=`${e.base_name}-mysql-${o[r]}`;t.push("--link",s),t.push("--add-host",e.db.mysql[o[r]].host+":"+getContainerIp(s,e))}}if(e.trans.sshd&&e.trans.sshd.enabled&&e.trans.sshd.external_port&&t.push("-p","auto"===e.trans.sshd.external_port?"22":`${e.trans.sshd.external_port}:22`),e.http.apache&&e.http.apache.enabled&&(t.push("-v",`${e.root}/${e.http.apache.public_dir}:/var/www/html`),e.http.apache.external_http_port&&t.push("-p","auto"===e.http.apache.external_http_port?"80":`${e.http.apache.external_http_port}:80`),e.http.apache.external_https_port&&t.push("-p","auto"===e.http.apache.external_https_port?"443":`${e.http.apache.external_https_port}:443`)),e.http.nginx&&e.http.nginx.enabled&&(t.push("-v",`${e.root}/${e.http.nginx.public_dir}:/usr/share/nginx/html`),e.http.nginx.external_http_port&&t.push("-p","auto"===e.http.nginx.external_http_port?"80":`${e.http.nginx.external_http_port}:80`),e.http.nginx.external_https_port&&t.push("-p","auto"===e.http.nginx.external_https_port?"443":`${e.http.nginx.external_https_port}:443`)),e.mail.sendlog&&e.mail.sendlog.enabled&&e.mail.sendlog.external_port&&t.push("-p","auto"===e.mail.sendlog.external_port?"9981":`${e.mail.sendlog.external_port}:9981`),e.log.fluentd&&t.push("-v",`${e.root}/.genie/files/opt/td-agent:/etc/td-agent`),e.core.docker.hosts&&Array.isArray(e.core.docker.hosts)&&e.core.docker.hosts.length)for(let o=0;o<e.core.docker.hosts.length;o++)t.push(`--add-host=${e.core.docker.hosts[o]}`);if(t.push("-v",`${e.root}/:/mnt/host/`),e.core.docker.mounts&&Array.isArray(e.core.docker.mounts)&&e.core.docker.mounts.length)for(let o=0;o<e.core.docker.mounts.length;o++)e.core.docker.mounts[o].match(/^\//)?t.push("-v",`${e.core.docker.mounts[o]}`):t.push("-v",`${e.root}/${e.core.docker.mounts[o]}`);let s={},n=(e,o)=>{if(e&&"object"==typeof e&&!Array.isArray(e)){let r=Object.keys(e);for(let t=0;t<r.length;t++)n(e[r[t]],`${o}_${r[t].toUpperCase()}`)}else"object"==typeof e&&Array.isArray(e)?s[o]=JSON.stringify(e):s[o]=e};n(e,"GENIE"),s.GENIE_RUNMODE=e.runmode;let l=Object.keys(s);for(let e=0;e<l.length;e++)t.push("-e",`${l[e]}=${s[l[e]]}`);t.push(e.core.docker.image);let c=child.spawnSync("docker",t);c.status?r(c.stderr.toString()):o()})),existContainers=module.exports.existContainers=((e,o)=>{let r=["--filter",`label=genie_root="${e.root}"`,"--filter",`label=genie_runmode="${e.runmode}"`];o&&r.push("--filter",`name=${o}`);let t=child.spawnSync("docker",["ps","-a","--format","{{.ID}}\t{{.Names}}",...r]);t.status&&Error(t.stderr.toString());let s=[];var n=!0,l=!1,c=void 0;try{for(var a,i=t.stdout.toString().split(/\n/)[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){let e=a.value.split(/\t+/);e[0]&&s.push({id:e[0],name:e[1]})}}catch(e){l=!0,c=e}finally{try{!n&&i.return&&i.return()}finally{if(l)throw c}}return!!s.length&&s}),getContainerIp=module.exports.getContainerIp=((e,o)=>{try{let r;if(!(r=o.core.docker.network?child.spawnSync("docker",["inspect",`--format={{.NetworkSettings.Networks.${o.core.docker.network}.IPAddress}}`,e]):child.spawnSync("docker",["inspect","--format={{.NetworkSettings.IPAddress}}",e])).stderr.toString())return r.stdout.toString().replace(/[\r\n]$/,"");Error(r.stderr.toString())}catch(e){Error(e)}}),sleep=module.exports.sleep=(e=>new Promise(o=>{setTimeout(o,e)}));
},{}],5:[function(require,module,exports) {
"use strict";function e(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,t){return function r(s,o){try{var a=n[s](o),i=a.value}catch(e){return void t(e)}if(!a.done)return Promise.resolve(i).then(function(e){r("next",e)},function(e){r("throw",e)});e(i)}("next")})}}const n=require("./libs.js");module.exports=(()=>{var t=e(function*(e){console.log(),n.Message("サンプル：default","default"),n.Message("サンプル：primary","primary"),n.Message("サンプル：success","success"),n.Message("サンプル：danger","danger"),n.Message("サンプル：warning","warning"),n.Message("サンプル：info","info"),n.Message("改行込み、1ライン入れも可能。\ntest1\ntest2\ntest3","default",1);let t=yield n.Input("入力BOX（入力文字を発音しますのでご注意）：",20);n.Message("入力された文字："+t),n.Say(t);try{throw new Error("エラーテスト（終了コード255）")}catch(e){console.log(e),process.exit(255)}});return function(e){return t.apply(this,arguments)}})();
},{"./libs.js":3}],7:[function(require,module,exports) {
"use strict";function e(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,r){return function t(i,o){try{var s=n[i](o),u=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(u).then(function(e){t("next",e)},function(e){t("throw",e)});e(u)}("next")})}}const n=require("./libs.js"),r=require("child_process");module.exports=(()=>{var t=e(function*(e){let t=e.usage("Usage: genie|g config [Options]").options("dump",{alias:"d",describe:"設定値を確認します。"}).argv;if(t.help)return console.log(),n.Message(e.help(),"primary",1);let i=n.loadConfig(t);if(t.dump)d(i);else{let e=`${n.getRootDir()}/.genie/${t.config}`;n.isWindows()?r.execSync(`start ${e}`):n.isMac()&&r.execSync(`open ${e}`)}});return function(e){return t.apply(this,arguments)}})();
},{"./libs.js":3}],9:[function(require,module,exports) {
"use strict";function t(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,r){return function o(n,s){try{var i=e[n](s),a=i.value}catch(t){return void r(t)}if(!i.done)return Promise.resolve(a).then(function(t){o("next",t)},function(t){o("throw",t)});t(a)}("next")})}}const e=require("./libs.js"),r=require("child_process"),o=require("cli-color"),n=require("cliui")({width:o.windowSize.width-4});module.exports=(()=>{var o=t(function*(t){e.showRunmode();let o=t.usage("Usage: genie|g ls [Options]").options("long",{alias:"l",describe:"コンテナ一覧がもうちょっとだけ詳細に出ます"}).argv;if(o.help)return console.log(),e.Message(t.help(),"primary",1);if(e.hasDockerMachineEnv()){console.log("\n  DockeMachines");let t=r.spawnSync("docker-machine",["ls"]);t.status&&e.Error(t.stderr.toString()),e.Message(t.stdout.toString(),"primary",1)}{console.log("\n  Images");let t=r.spawnSync("docker",["images"]);t.status&&e.Error(t.stderr.toString()),e.Message(t.stdout.toString(),"primary",1)}{console.log("\n  Volumes");let t=r.spawnSync("docker",["volume","ls","--format","table {{.Name}}\t{{.Driver}}\t{{.Scope}}"]);t.status&&e.Error(t.stderr.toString()),e.Message(t.stdout.toString(),"primary",1)}{console.log("\n  Containers");let t=["--format","{{.Names}}\t{{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"],s=["NAMES","ID","IMAGE","STATUS","PORTS"];o.long&&(t=["--format","{{.Names}}\t{{.ID}}\t{{.Image}}\t{{.Command}}\t{{.CreatedAt}}\t{{.Status}}\t{{.Ports}}\t{{.Labels}}"],s=["NAMES","ID","IMAGE","COMMAND","CREATED","STATUS","PORTS","LABELS"]);let i=r.spawnSync("docker",["ps","-a",...t]);i.status&&e.Error(i.stderr.toString());let a=i.stdout.toString().trim().split("\n");a.unshift(s.join("\t"));for(let t in a){let e=a[t].split(/\t/),r=[];for(let t in e){let n;o.long?(6==t&&(n=30),7==t&&(n=50)):4==t&&(n=30),r.push({text:e[t].replace(/, ?/g,"\n"),width:n,padding:[0,1,0,1]})}n.div(...r)}e.Message(n.toString(),"primary",1)}});return function(t){return o.apply(this,arguments)}})();
},{"./libs.js":3}],11:[function(require,module,exports) {
"use strict";function e(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(o,s){try{var l=t[o](s),a=l.value}catch(e){return void r(e)}if(!l.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}("next")})}}const t=require("./libs.js"),r=require("child_process"),n=require("cli-color"),o=require("fs");module.exports=(()=>{var s=e(function*(s){let l=s.usage("Usage: genie|g up [Options]").argv;if(l.help)return console.log(),t.Message(s.help(),"primary",1);let a=t.loadConfig(l);if(t.showRunmode(),a.core.memo)try{let e=a.core.memo.up;e&&t.Messages(e)}catch(e){Error("メモの設定が異常です。")}return new Promise((i=e(function*(e,s){let l=[];if(yield t.dockerDown(a),a.db.postgresql){o.chmodSync(`${a.root}/.genie/files/opt/postgresql/before-entrypoint.sh`,493);var i=!0,u=!1,p=void 0;try{for(var c,y=Object.keys(a.db.postgresql)[Symbol.iterator]();!(i=(c=y.next()).done);i=!0){let e=c.value;l.push(t.dockerUpPostgreSQL(e,a))}}catch(e){u=!0,p=e}finally{try{!i&&y.return&&y.return()}finally{if(u)throw p}}}if(a.db.mysql){o.chmodSync(`${a.root}/.genie/files/opt/mysql/before-entrypoint.sh`,493);var d=!0,m=!1,f=void 0;try{for(var g,b=Object.keys(a.db.mysql)[Symbol.iterator]();!(d=(g=b.next()).done);d=!0){let e=g.value;l.push(t.dockerUpMySQL(e,a))}}catch(e){m=!0,f=e}finally{try{!d&&b.return&&b.return()}finally{if(m)throw f}}}Promise.all(l).catch(function(e){t.Error(e)}).then(function(){return t.dockerUp(a).catch(function(e){return t.Error(e)})}),console.log();let $,v=0,w=[];do{if($=[],a.db.postgresql&&Object.keys(a.db.postgresql).length){var _=!0,x=!1,q=void 0;try{for(var S,O=Object.keys(a.db.postgresql)[Symbol.iterator]();!(_=(S=O.next()).done);_=!0){let e=S.value,t=`${a.base_name}-postgresql-${e}`,o=r.spawnSync("docker",["exec",t,"sh","-c","ps aux|grep entrypoint.sh|grep -v grep|wc -l"]);-1!==w.indexOf(t)||"0"===o.stdout.toString().trim()?($.push(`  ${t} ... ${n.green("ready!")}`),-1===w.indexOf(t)&&w.push(t)):$.push(`  ${t} ... ${n.yellow("loading")}`)}}catch(e){x=!0,q=e}finally{try{!_&&O.return&&O.return()}finally{if(x)throw q}}}if(a.db.mysql&&Object.keys(a.db.mysql).length){var P=!0,k=!1,j=void 0;try{for(var N,E=Object.keys(a.db.mysql)[Symbol.iterator]();!(P=(N=E.next()).done);P=!0){let e=N.value,t=`${a.base_name}-mysql-${e}`,o=r.spawnSync("docker",["logs",t]);-1!==w.indexOf(t)||o.stdout.toString().match(/MySQL Community Server \(GPL\)/)?($.push(`  ${t} ... ${n.green("ready!")}`),-1===w.indexOf(t)&&w.push(t)):process.env[`DOCKER_IMAGE_DOWN_LOADING_${t.toUpperCase()}`]?$.push(`  ${t} ... ${n.yellow("image downloading")}`):$.push(`  ${t} ... ${n.yellow("loading")}`)}}catch(e){k=!0,j=e}finally{try{!P&&E.return&&E.return()}finally{if(k)throw j}}}let e=r.spawnSync("docker",["exec",a.base_name,"cat","/var/log/entrypoint.log"]).stdout.toString();-1!==w.indexOf(a.base_name)||e.match(/entrypoint\.sh setup done\./)?(-1===w.indexOf(a.base_name)&&w.push(a.base_name),$.push(`  ${a.base_name} ... ${n.green("ready!")}`)):e.match(/init\.sh setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("init.sh setup")}`):e.match(/Postfix setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("Postfix setup")}`):e.match(/Nginx setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("Nginx setup")}`):e.match(/Apache setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("Apache setup")}`):e.match(/Node.js setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("Node.js setup")}`):e.match(/Ruby setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("Ruby setup")}`):e.match(/PHP setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("PHP setup")}`):e.match(/Perl setup done\./)?$.push(`  ${a.base_name} ... ${n.yellow("Perl setup")}`):e.match(/entrypoint\.sh setup start\./)?$.push(`  ${a.base_name} ... ${n.yellow("loading")}`):$.push(`  ${a.base_name} ... ${n.yellow("waiting")}`),v++&&process.stdout.write(n.move.up($.length));var L=!0,M=!1,U=void 0;try{for(var A,C=$[Symbol.iterator]();!(L=(A=C.next()).done);L=!0){let e=A.value;process.stdout.write(n.erase.line),console.log(e)}}catch(e){M=!0,U=e}finally{try{!L&&C.return&&C.return()}finally{if(M)throw U}}w.length!==$.length&&(yield t.sleep(100))}while(w.length!==$.length);h("起動完了!!"),e()}),function(e,t){return i.apply(this,arguments)}));var i});return function(e){return s.apply(this,arguments)}})();
},{"./libs.js":3}],13:[function(require,module,exports) {
"use strict";function e(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,r){return function t(o,i){try{var u=n[o](i),s=u.value}catch(e){return void r(e)}if(!u.done)return Promise.resolve(s).then(function(e){t("next",e)},function(e){t("throw",e)});e(s)}("next")})}}const n=require("./libs.js"),r=require("child_process");module.exports=(()=>{var r=e(function*(r){let t=r.usage("Usage: genie|g down [Options]").options("volumes",{alias:"v",describe:"関連するVolumeも一緒に削除する"}).argv;if(t.help)return console.log(),n.Message(r.help(),"primary",1);let o=n.loadConfig(t);if(o.core.memo)try{let e=o.core.memo.down;e&&n.Messages(e)}catch(e){Error("メモの設定が異常です。")}return new Promise((i=e(function*(e,r){yield Promise.all([n.dockerDown(o,t.v)]).catch(function(e){return e}).then(function(){h("停止/削除完了!!"),e()})}),function(e,n){return i.apply(this,arguments)}));var i});return function(e){return r.apply(this,arguments)}})();
},{"./libs.js":3}],15:[function(require,module,exports) {
"use strict";function e(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){return function n(o,s){try{var i=r[o](s),c=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(c).then(function(e){n("next",e)},function(e){n("throw",e)});e(c)}("next")})}}const r=require("./libs.js"),t=require("child_process");module.exports=(()=>{var n=e(function*(e){let n=e.usage("Usage: genie|g cli [Options] [Commands]").options("host",{describe:"実行するホスト名を指定する"}).argv;if(n.help)return console.log(),r.Message(e.help(),"primary",1);let o=r.loadConfig(n),s=n.host?n.host:o.core.docker.name,i=process.argv.slice(process.argv.findIndex(function(e){return e===n._[1]}));if(r.existContainers(o,"/"+s+"$")||r.Error("dockerコンテナが起動していません: "+s),1!==n._.length){let e=t.spawnSync("docker",["exec",s,...i]);e.status?r.Error(e.stderr.toString()||e.stdout.toString()):console.log(e.stdout.toString())}else t.spawnSync("docker",["exec","-it",s,"bash"],{stdio:"inherit"})});return function(e){return n.apply(this,arguments)}})();
},{"./libs.js":3}],17:[function(require,module,exports) {
"use strict";function e(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){return function o(n,l){try{var i=r[n](l),a=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(a).then(function(e){o("next",e)},function(e){o("throw",e)});e(a)}("next")})}}const r=require("./libs.js"),t=require("child_process"),o=require("inquirer"),n=require("cli-color");module.exports=(()=>{var l=e(function*(e){let l=e.usage("Usage: genie|g reject [Options]").options("force",{alias:"f",describe:"選択肢を出さずにすぐに削除を開始する"}).options("locked",{alias:"l",describe:"「locked_」から始まるボリューム・コンテナも対象にする"}).argv;if(l.help)return console.log(),r.Message(e.help(),"primary",1);let i=[],a=t.spawnSync("docker",["ps","-qa","--format","{{.Names}}\t{{.Status}}"]);a.status&&r.Error(a.stderr.toString());var c=!0,s=!1,u=void 0;try{for(var f,d=a.stdout.toString().trim().split(/\n/)[Symbol.iterator]();!(c=(f=d.next()).done);c=!0){let e=f.value;if(!e)continue;let r=e.split(/\t/),t=r[0],o=(r[1],t.match(/^locked_/)),a=`[Container] ${t}`;o&&(a=n.blackBright(a)),i.push({name:a,checked:!(o&&!l.locked)})}}catch(e){s=!0,u=e}finally{try{!c&&d.return&&d.return()}finally{if(s)throw u}}let m=[];(a=t.spawnSync("docker",["volume","ls","--format","{{.Name}}\t{{.Driver}}"])).status&&r.Error(a.stderr.toString());var y=!0,p=!1,v=void 0;try{for(var g,w=a.stdout.toString().trim().split(/\n/)[Symbol.iterator]();!(y=(g=w.next()).done);y=!0){let e=g.value;if(!e)continue;let r=e.split(/\t/),t=r[0],o=(r[1],t.match(/^locked_/)),i=`[Volume] ${t}`;o&&(i=n.blackBright(i)),m.push({name:i,checked:!(o&&!l.locked)})}}catch(e){p=!0,v=e}finally{try{!y&&w.return&&w.return()}finally{if(p)throw v}}let k,S=i.length+m.length;if(0===S)return h("対象のオブジェクトはありませんでした。");if(l.force){let e=[...i,...m];(k={}).rejects=[];var b=!0,$=!1,x=void 0;try{for(var j,q=e[Symbol.iterator]();!(b=(j=q.next()).done);b=!0){let e=j.value;e.checked&&k.rejects.push(e.name)}}catch(e){$=!0,x=e}finally{try{!b&&q.return&&q.return()}finally{if($)throw x}}}else{if(console.log(),!(k=yield o.prompt([{type:"checkbox",message:"削除したいものにチェックを入れて Enter してください。",name:"rejects",pageSize:100,choices:[...i,...m]}])).rejects.length)return;process.stdout.write(n.move.up(S));for(let e=0;e<S;e++)process.stdout.write(n.erase.line),process.stdout.write(n.move.down(1));process.stdout.write(n.move.up(S))}let P=[],C=[];var E=!0,V=!1,_=void 0;try{for(var B,N=k.rejects[Symbol.iterator]();!(E=(B=N.next()).done);E=!0){let e=B.value,r=(e=n.strip(e)).match(/^\[(Container|Volume)\] (.+)$/);"Container"===r[1]?C.push(r[2]):"Volume"===r[1]&&P.push(r[2])}}catch(e){V=!0,_=e}finally{try{!E&&N.return&&N.return()}finally{if(V)throw _}}console.log();let z=[];var D=!0,M=!1,O=void 0;try{for(var U,A=C[Symbol.iterator]();!(D=(U=A.next()).done);D=!0){let e=U.value;z.push(new Promise(function(r,o){t.spawn("docker",["rm","-fv",e]).stderr.on("data",function(r){console.log(`  [Container] ${e} - ${n.red("ng")}`),o(r)}).on("close",function(t){console.log(`  [Container] ${e} - ${n.green("deleted")}`),r()})}))}}catch(e){M=!0,O=e}finally{try{!D&&A.return&&A.return()}finally{if(M)throw O}}yield Promise.all(z).catch(function(e){r.Error(e)}),z=[];var F=!0,G=!1,H=void 0;try{for(var I,J=P[Symbol.iterator]();!(F=(I=J.next()).done);F=!0){let e=I.value;z.push(new Promise(function(r,o){t.spawn("docker",["volume","rm","-f",e]).stderr.on("data",function(r){console.log(`  [Volume] ${e} - ${n.red("ng")}`),o(r)}).on("close",function(t){console.log(`  [Volume] ${e} - ${n.green("deleted")}`),r()})}))}}catch(e){G=!0,H=e}finally{try{!F&&J.return&&J.return()}finally{if(G)throw H}}yield Promise.all(z).catch(function(e){r.Error(e)})});return function(e){return l.apply(this,arguments)}})();
},{"./libs.js":3}],19:[function(require,module,exports) {
"use strict";function r(r){return function(){var e=r.apply(this,arguments);return new Promise(function(r,t){return function n(o,i){try{var l=e[o](i),a=l.value}catch(r){return void t(r)}if(!l.done)return Promise.resolve(a).then(function(r){n("next",r)},function(r){n("throw",r)});r(a)}("next")})}}const e=require("./libs.js"),t=require("child_process"),n=require("cli-color");module.exports=(()=>{var o=r(function*(r){let o,i,l=r.usage("Usage: genie|g clean [Options]").options("force",{alias:"f",describe:"lockedから始まる名前も対象にする"}).argv;if(l.help)return console.log(),e.Message(r.help(),"primary",1);let a,s=0;a=[],o=["ps","-qa","--filter","exited=0","--format","{{.Names}}"],(i=t.spawnSync("docker",o)).status&&e.Error(i.stderr.toString());var c=!0,u=!1,f=void 0;try{for(var d,m=i.stdout.toString().trim().split(/\n/)[Symbol.iterator]();!(c=(d=m.next()).done);c=!0){let r=d.value;r&&(!l.f&&r.match(/^locked_/i)||a.push(new Promise(function(e,o){s++||console.log(),t.spawn("docker",["rm","-fv",r]).stderr.on("data",function(r){return o(r)}).on("close",function(t){console.log(`  [Container] ${r} - ${n.green("deleted")}`),e()})})))}}catch(r){u=!0,f=r}finally{try{!c&&m.return&&m.return()}finally{if(u)throw f}}yield Promise.all(a).catch(function(r){e.Error(r)}),a=[],o=["volume","ls","--filter","dangling=true","--format","{{.Name}}"],(i=t.spawnSync("docker",o)).status&&e.Error(i.stderr.toString());var g=!0,y=!1,p=void 0;try{for(var v,w=i.stdout.toString().trim().split(/\n/)[Symbol.iterator]();!(g=(v=w.next()).done);g=!0){let r=v.value;r&&(!l.f&&r.match(/^locked_/i)||a.push(new Promise(function(e,o){s++||console.log(),t.spawn("docker",["volume","rm","-f",r]).stderr.on("data",function(r){return o(r)}).on("close",function(t){console.log(`  [Volume] ${r} - ${n.green("deleted")}`),e()})})))}}catch(r){y=!0,p=r}finally{try{!g&&w.return&&w.return()}finally{if(y)throw p}}yield Promise.all(a).catch(function(r){e.Error(r)}),o=["images","-q","--filter","dangling=true"],(i=t.spawnSync("docker",o)).status&&e.Error(i.stderr.toString());var S=!0,k=!1,P=void 0;try{for(var x,E=i.stdout.toString().trim().split(/\n/)[Symbol.iterator]();!(S=(x=E.next()).done);S=!0){let r=x.value;r&&a.push(new Promise(function(e,o){s++||console.log(),t.spawn("docker",["rmi",r]).stderr.on("data",function(r){return o(r)}).on("close",function(t){console.log(`  [Image] ${r} - ${n.green("deleted")}`),e()})}))}}catch(r){k=!0,P=r}finally{try{!S&&E.return&&E.return()}finally{if(k)throw P}}yield Promise.all(a).catch(function(r){e.Error(r)}),s||h("対象のオブジェクトはありませんでした。")});return function(r){return o.apply(this,arguments)}})();
},{"./libs.js":3}],21:[function(require,module,exports) {
"use strict";function e(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,o){return function r(t,i){try{var c=n[t](i),s=c.value}catch(e){return void o(e)}if(!c.done)return Promise.resolve(s).then(function(e){r("next",e)},function(e){r("throw",e)});e(s)}("next")})}}const n=require("./libs.js"),o=require("child_process"),r=require("cli-color");module.exports=(()=>{var t=e(function*(e){let t=e.usage("Usage: genie|g build [Options]").options("no-cache",{alias:"n",describe:"キャッシュを使用せずにビルドする"}).argv;if(t.help)return console.log(),n.Message(e.help(),"primary",1);let i=n.loadConfig(t);if((yield n.Input(`${i.core.docker.image} イメージをビルドしてもよろしいでしょうか。[y/N]: `)).match(/^y$/i)){let e=["build","-t",i.core.docker.image];t["no-cache"]&&e.push("--no-cache"),e.push(`${n.getRootDir()}/.genie/image/`),n.Message(`ビルドを開始します。\ndocker ${e.join(" ")}`,"info"),console.log();let c=o.spawn("docker",e);c.stdout.on("data",function(e){console.log(r.blackBright(e.toString().trim()))}),c.stderr.on("data",function(e){n.Error(e)}),c.on("close",function(e){let o="ビルドが完了しました。";n.Message(o),n.Say(o)})}});return function(e){return t.apply(this,arguments)}})();
},{"./libs.js":3}],23:[function(require,module,exports) {
"use strict";function n(n){return function(){var e=n.apply(this,arguments);return new Promise(function(n,i){return function r(t,o){try{var s=e[t](o),a=s.value}catch(n){return void i(n)}if(!s.done)return Promise.resolve(a).then(function(n){r("next",n)},function(n){r("throw",n)});n(a)}("next")})}}const e=require("./libs.js"),i=require("child_process");module.exports=(()=>{var r=n(function*(n){let r=n.usage("Usage: genie|g langver [Options] [Language]").argv,t=n.help()+"\nLanguage:\n  php\n  perl\n  ruby\n  node\n";if(r.help)return console.log(),e.Message(t,"primary",1);if(r._[1].match(/^php$/i)){let n=i.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/phpenv/plugins/php-build/bin/php-build --definitions"]);e.Message(n.stdout.toString(),"primary")}else if(r._[1].match(/^perl$/i)){let n=i.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/plenv/plugins/perl-build/perl-build  --definitions"]);e.Message(n.stdout.toString(),"primary")}else if(r._[1].match(/^ruby$/i)){let n=i.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/rbenv/plugins/ruby-build/bin/ruby-build  --definitions"]);e.Message(n.stdout.toString(),"primary")}else if(r._[1].match(/^node$/i)){let n=i.spawnSync("docker",["run","--rm","--entrypoint=bash","kazaoki/genie","-c","/root/.anyenv/envs/ndenv/plugins/node-build/bin/node-build  --definitions"]);e.Message(n.stdout.toString(),"primary")}else console.log(),e.Message(t,"primary",1)});return function(n){return r.apply(this,arguments)}})();
},{"./libs.js":3}],25:[function(require,module,exports) {
"use strict";function e(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){return function n(s,l){try{var i=r[s](l),a=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}("next")})}}const r=require("./libs.js"),t=require("child_process"),n=require("inquirer"),s=require("fs");function l(t,s={}){return 1===Object.keys(t.db.mysql).length?`${t.base_name}-mysql-${Object.keys(t.db.mysql)[0]}`:e(function*(){let e=[];var l=!0,i=!1,a=void 0;try{for(var o,y=Object.keys(t.db.mysql)[Symbol.iterator]();!(l=(o=y.next()).done);l=!0){let r=o.value;e.push(`${r} (${t.base_name}-mysql-${r})`)}}catch(e){i=!0,a=e}finally{try{!l&&y.return&&y.return()}finally{if(i)throw a}}s.has_all&&e.push("全て"),console.log();let c=yield n.prompt([{type:"list",message:"対象のMySQLコンテナを選択してください。",name:"container",pageSize:100,choices:e}]).catch(function(e){r.Error(e)});if("全て"===c.container)return s.is_key_return?Object.keys(t.db.mysql):Object.keys(t.db.mysql).map(function(e){return`${t.base_name}-mysql-${e}`});{let e=c.container.match(/^(\w+) /);return s.is_key_return?e[1]:`${t.base_name}-mysql-${e[1]}`}})()}function i(e,r){let t;var n=!0,s=!1,l=void 0;try{for(var i,a=Object.keys(e.db.mysql)[Symbol.iterator]();!(n=(i=a.next()).done);n=!0){let n=i.value;if(r===`${e.base_name}-mysql-${n}`){t=n;break}}}catch(e){s=!0,l=e}finally{try{!n&&a.return&&a.return()}finally{if(s)throw l}}return t}module.exports=(()=>{var n=e(function*(e){let n=e.usage("Usage: genie|g mysql [Options]").options("cli",{alias:"c",describe:"MySQLコンテナのCLIに入る",boolean:!0}).options("dump",{alias:"d",describe:"MySQLのダンプを取る",boolean:!0}).options("restore",{alias:"r",describe:"MySQLのリストアを行う",boolean:!0}).options("all",{alias:"a",describe:"管轄全てのMySQLを対象とする（--dump, --restoreのみ）",boolean:!0}).argv;if(n.help)return console.log(),r.Message(e.help(),"primary",1);let a=r.loadConfig(n);if(a.db.mysql&&Object.keys(a.db.mysql).length||r.Error("MySQL設定がありません。"),r.existContainers(a,"/"+a.base_name+"$")||r.Error("dockerコンテナが起動していません: "+a.base_name),n.cli){let e=n._[1]?`${a.base_name}-mysql-${n._[1]}`:yield l(a,{is_single:!0});i(a,e);t.spawnSync("docker",["exec","-it",e,"bash"],{stdio:"inherit"})}else if(n.dump){n._.shift();let e=n.all?Object.keys(a.db.mysql):n._.length?n._:yield l(a,{has_all:!0,is_key_return:!0});Array.isArray(e)||(e=[e]);let t=`${a.root}/.genie/files/opt/mysql/dumps`;s.existsSync(t)||s.mkdirSync(t,493);var o=!0,y=!1,c=void 0;try{for(var u,m=e[Symbol.iterator]();!(o=(u=m.next()).done);o=!0){let e=u.value;a.db.mysql[e]||r.Error("指定のキーのMySQL設定が定義されていません。"+e),d(e)}}catch(e){y=!0,c=e}finally{try{!o&&m.return&&m.return()}finally{if(y)throw c}}}else if(n.restore){d("RESTORE");let e=yield l(a,{has_all:!0});d(e)}else{let e=n._[1]?`${a.base_name}-mysql-${n._[1]}`:yield l(a,{is_single:!0}),s=i(a,e);a.db.mysql[s]||r.Error("指定のキーのMySQL設定が定義されていません。"+s),t.spawnSync("docker",["exec","-it",e,"mysql",a.db.mysql[s].name,`-u${a.db.mysql[s].user}`,`-p${a.db.mysql[s].pass}`],{stdio:"inherit"})}});return function(e){return n.apply(this,arguments)}})();
},{"./libs.js":3}],27:[function(require,module,exports) {
"use strict";function e(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){return function s(n,o){try{var i=r[n](o),l=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(l).then(function(e){s("next",e)},function(e){s("throw",e)});e(l)}("next")})}}const r=require("./libs.js"),t=require("child_process"),s=require("inquirer");function n(t,n,o={}){return n.name?o.is_single&&Array.isArray(n.name)?n.name[0]:n.name:1===Object.keys(t.db.postgresql).length?`${t.base_name}-postgresql-${Object.keys(t.db.postgresql)[0]}`:e(function*(){let e=[];var n=!0,i=!1,l=void 0;try{for(var a,c=Object.keys(t.db.postgresql)[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){let r=a.value;e.push(`${r} (${t.base_name}-postgresql-${r})`)}}catch(e){i=!0,l=e}finally{try{!n&&c.return&&c.return()}finally{if(i)throw l}}o.has_all&&e.push("全て"),console.log();let u=yield s.prompt([{type:"list",message:"対象のPostgreSQLコンテナを選択してください。",name:"container",pageSize:100,choices:e}]).catch(function(e){r.Error(e)});if("全て"===u.container){let e=[];var d=!0,p=!1,g=void 0;try{for(var y,b=Object.keys(t.db.postgresql)[Symbol.iterator]();!(d=(y=b.next()).done);d=!0){let r=y.value;e.push(`${t.base_name}-postgresql-${r}`)}}catch(e){p=!0,g=e}finally{try{!d&&b.return&&b.return()}finally{if(p)throw g}}return e}{let e=u.container.match(/^(\w+) /);return`${t.base_name}-postgresql-${e[1]}`}})()}function o(e,r){let t;var s=!0,n=!1,o=void 0;try{for(var i,l=Object.keys(e.db.postgresql)[Symbol.iterator]();!(s=(i=l.next()).done);s=!0){let s=i.value;if(r===`${e.base_name}-postgresql-${s}`){t=s;break}}}catch(e){n=!0,o=e}finally{try{!s&&l.return&&l.return()}finally{if(n)throw o}}return t}module.exports=(()=>{var s=e(function*(e){let s=e.usage("Usage: genie|g psql [Options]").options("cli",{describe:"PostgreSQLコンテナのCLIに入る"}).options("dump",{alias:"d",describe:"PostgreSQLのダンプを取る"}).options("restore",{alias:"r",describe:"PostgreSQLのリストアを行う"}).options("name",{alias:"n",describe:"対象のPostgreSQLコンテナ名を直接指定する"}).argv;if(s.help)return console.log(),r.Message(e.help(),"primary",1);let i=r.loadConfig(s);if(i.db.postgresql&&Object.keys(i.db.postgresql).length||r.Error("PostgreSQL設定がありません。"),r.existContainers(i,"/"+i.base_name+"$")||r.Error("dockerコンテナが起動していません: "+i.base_name),s.cli){let e=yield n(i,s,{is_single:!0});o(i,e);t.spawnSync("docker",["exec","-it",e,"bash"],{stdio:"inherit"})}else if(s.dump){d("DUMP");let e=yield n(i,s,{has_all:!0});d(e)}else if(s.restore){d("RESTORE");let e=yield n(i,s,{has_all:!0});d(e)}else{let e=yield n(i,s,{is_single:!0}),r=o(i,e);t.spawnSync("docker",["exec","-it",e,"psql",i.db.postgresql[r].name,"-U",i.db.postgresql[r].user],{stdio:"inherit"})}});return function(e){return s.apply(this,arguments)}})();
},{"./libs.js":3}],29:[function(require,module,exports) {
"use strict";function r(r){return function(){var e=r.apply(this,arguments);return new Promise(function(r,t){return function o(n,a){try{var s=e[n](a),i=s.value}catch(r){return void t(r)}if(!s.done)return Promise.resolve(i).then(function(r){o("next",r)},function(r){o("throw",r)});r(i)}("next")})}}const e=require("./libs.js"),t=require("child_process"),o=require("cli-color");module.exports=(()=>{var o=r(function*(r){let o=r.usage("Usage: genie|g open [Options] [URL]").options("one",{alias:"o",describe:"設定にかかわらず既定のブラウザ1つで開く"}).argv;if(o.help)return console.log(),e.Message(r.help(),"primary",1);let n=e.loadConfig(o),a=!0===o.o?o._[1]:o.o?o.o:o._[1];if(a||e.existContainers(n,"/"+n.base_name+"$")||e.Error("dockerコンテナが起動していません: "+n.base_name),!a){let r="https"===n.http.browser.schema?443:80,e=t.spawnSync("docker",["port",n.base_name,r]);e.status&&Error(e.stderr.toString());let o=e.stdout.toString().trim().match(/(\d+)$/)[1];o="http"===n.http.browser.schema&&80==o||"https"===n.http.browser.schema&&443==o?"":`:${o}`,a=`${n.http.browser.schema}://${n.host_ip}${o}${n.http.browser.path}`}let s=e.isWindows?"start":e.isMac?"open":"xdg-open",i=[];if(o.o)i.push(`${s} ${a}`);else{n.http.browser.apps&&n.http.browser.apps.length||(n.http.browser.apps=[""]);var p=!0,h=!1,c=void 0;try{for(var l,u=n.http.browser.apps[Symbol.iterator]();!(p=(l=u.next()).done);p=!0){let r=l.value,t="";e.isWindows()?"chrome"===r?t=" chrome":"firefox"===r?t=" firefox":"ie"===r?t=" explorer":"opera"===r?t=" opera":r&&(t=` ${r}`):"chrome"===r?t=" -a chrome":"firefox"===r?t=" -a firefox":"safari"===r?t=" -a safari":"opera"===r?t=" -a opera":r&&(t=` -a ${r}`),i.push(`${s}${t} ${a}`)}}catch(r){h=!0,c=r}finally{try{!p&&u.return&&u.return()}finally{if(h)throw c}}}var f=!0,m=!1,d=void 0;try{for(var b,w=i[Symbol.iterator]();!(f=(b=w.next()).done);f=!0){let r=b.value;t.execSync(r)}}catch(r){m=!0,d=r}finally{try{!f&&w.return&&w.return()}finally{if(m)throw d}}});return function(r){return o.apply(this,arguments)}})();
},{"./libs.js":3}],31:[function(require,module,exports) {
"use strict";function r(r){return function(){var e=r.apply(this,arguments);return new Promise(function(r,t){return function n(o,i){try{var a=e[o](i),l=a.value}catch(r){return void t(r)}if(!a.done)return Promise.resolve(l).then(function(r){n("next",r)},function(r){n("throw",r)});r(l)}("next")})}}const e=require("./libs.js"),t=require("child_process");module.exports=(()=>{var n=r(function*(r){let n=r.usage("Usage: genie|g logs [Options] [Commands]").argv;if(n.help)return console.log(),e.Message(r.help(),"primary",1);let o=e.loadConfig(n);e.existContainers(o,`/${o.base_name}$`)||e.Error("dockerコンテナが起動していません: "+docker.run.base_name);let i=[];try{if(!(o.log.tail&&o.log.tail[0]&&o.log.tail[0].length))throw new Error("ログ設定が正しくありません。");o.log.tail.length>1&&i.push("-s","2");var a=!0,l=!1,s=void 0;try{for(var u,c=o.log.tail[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){let r=u.value,e=!0;var f=!0,h=!1,y=void 0;try{for(var p,g=r[Symbol.iterator]();!(f=(p=g.next()).done);f=!0){let r=p.value;if("object"==typeof r&&Array.isArray(r))i.push("-ci",r[1]),e||i.push("-I"),i.push(r[0]);else{if("string"!=typeof r)throw new Error("ログ設定が正しくない可能性があります。（指定できるのは文字列か配列のみです）"+r);e||i.push("-I"),i.push(r)}e=!1}}catch(r){h=!0,y=r}finally{try{!f&&g.return&&g.return()}finally{if(h)throw y}}}}catch(r){l=!0,s=r}finally{try{!a&&c.return&&c.return()}finally{if(l)throw s}}}catch(r){e.Error(r)}t.spawnSync("docker",["exec","-it",o.base_name,"multitail",...i],{stdio:"inherit"})});return function(r){return n.apply(this,arguments)}})();
},{"./libs.js":3}],33:[function(require,module,exports) {
"use strict";function e(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){return function o(i,n){try{var s=r[i](n),u=s.value}catch(e){return void t(e)}if(!s.done)return Promise.resolve(u).then(function(e){o("next",e)},function(e){o("throw",e)});e(u)}("next")})}}const r=require("./libs.js"),t=require("fs"),o=require("child_process"),i=require("inquirer"),n=require("cli-color");module.exports=(()=>{var o=e(function*(e){let o=e.usage("Usage: genie|g test [Options] [test paths/files]").options("mode",{alias:"M",default:"test",describe:"実行モードを指定可能（test時はデフォルト`test`）"}).options("open",{alias:"o",describe:"dockerホスト側のChromeブラウザを開きオートテストを実行する"}).argv;if(o.help)return console.log(),r.Message(e.help(),"primary",1);process.env.GENIE_RUNMODE=o.mode;r.loadConfig(o);let i=`${r.getRootDir()}/tests/`;try{if(!t.readdirSync(i).length)throw new Error}catch(e){r.Error(`${i} にテストスクリプトを配置してください。`)}yield CMDS.up(e);r.Message(`テストコマンドを実行します。\n${["npx","mocha","--reporter","mochawesome","--recursive","tests","--reporter-options","reportDir=tests-report/mochawesome-report/,quiet=true"].join(" ")}`,"primary",1),yield CMDS.down(e)});return function(e){return o.apply(this,arguments)}})();
},{"./libs.js":3}],37:[function(require,module,exports) {
module.exports={name:"genie-cmd",description:"node版genie",version:"0.0.25",license:"MIT",private:!1,bin:{genie:"dist/genie",g:"dist/genie"},scripts:{dev:"npx parcel watch src/genie.js --out-dir dist --out-file genie --target node --no-source-maps",build:"npx parcel build src/genie.js --out-dir dist --out-file genie --target node --no-source-maps --no-cache && node src/build-after.js",test:"npx mocha --recursive tests --reporter mochawesome --reporter-options reportDir=tests-report/mochawesome-report/,quiet=true & start chrome tests-report/mochawesome-report/mochawesome.html","test-in-mac":"npx mocha --recursive tests --reporter mochawesome --reporter-options reportDir=tests-report/mochawesome-report,quiet=true,autoOpen=true"},devDependencies:{"parcel-bundler":"^1.7.1",puptester:"^0.0.2"},dependencies:{"cli-color":"^1.2.0",cliui:"^4.1.0",inquirer:"^5.2.0","jp-wrap":"^0.2.2",mocha:"^5.2.0",mochawesome:"^3.0.2",optimist:"^0.6.1","string-width":"^2.1.1"}};
},{}],35:[function(require,module,exports) {
"use strict";function r(r){return function(){var e=r.apply(this,arguments);return new Promise(function(r,n){return function t(o,i){try{var u=e[o](i),s=u.value}catch(r){return void n(r)}if(!u.done)return Promise.resolve(s).then(function(r){t("next",r)},function(r){t("throw",r)});r(s)}("next")})}}const e=require("./libs.js");module.exports=(()=>{var n=r(function*(r){var n=require("../package.json");process.stdout.write("\n"),e.Message(`${n.name} ver ${n.version}`,"primary"),process.stdout.write("\n")});return function(r){return n.apply(this,arguments)}})();
},{"./libs.js":3,"../package.json":37}],1:[function(require,module,exports) {
"use strict";function e(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,i){return function s(r,l){try{var o=n[r](l),d=o.value}catch(e){return void i(e)}if(!o.done)return Promise.resolve(d).then(function(e){s("next",e)},function(e){s("throw",e)});e(d)}("next")})}}const n=require("optimist"),i=require("./libs.js");global.d=i.d,global.h=i.h,console.time("  Done"),global.CMDS={demo:require("./cmd-demo.js"),config:require("./cmd-config.js"),ls:require("./cmd-ls.js"),up:require("./cmd-up.js"),down:require("./cmd-down.js"),cli:require("./cmd-cli.js"),reject:require("./cmd-reject.js"),clean:require("./cmd-clean.js"),build:require("./cmd-build.js"),langver:require("./cmd-langver.js"),mysql:require("./cmd-mysql.js"),psql:require("./cmd-psql.js"),open:require("./cmd-open.js"),logs:require("./cmd-logs.js"),test:require("./cmd-test.js"),version:require("./cmd-version.js")};let s=n.usage("Usage: genie|g [Commands] [Options]").options("mode",{alias:"M",default:"develop",describe:"実行モードを指定可能"}).options("config",{alias:"C",default:"config.js",describe:"設定ファイルを指定可能"}).options("help",{alias:"h",describe:"説明表示"}).argv;process.env.GENIE_RUNMODE=s.mode,e(function*(){let e=s._.shift();"demo"===e?yield CMDS.demo(n):"config"===e?yield CMDS.config(n):"ls"===e?yield CMDS.ls(n):"up"===e?yield CMDS.up(n):"down"===e?yield CMDS.down(n):"cli"===e?yield CMDS.cli(n):"reject"===e?yield CMDS.reject(n):"clean"===e?yield CMDS.clean(n):"build"===e?yield CMDS.build(n):"langver"===e?yield CMDS.langver(n):"mysql"===e?yield CMDS.mysql(n):"psql"===e?yield CMDS.psql(n):"open"===e?yield CMDS.open(n):"logs"===e?yield CMDS.logs(n):"test"===e?yield CMDS.test(n):"version"===e?yield CMDS.version(n):(console.log(),i.Message(n.help()+"\nCommands:\n  init      \n  config    設定を確認する\n  ls        Dockerコンテナ状況を確認する\n  up        設定に基づきDockerコンテナを起動する\n  down      関連するコンテナのみ終了する\n  update    \n  cli       コンテナ内でコマンドを実行。またはコンテナに入る\n  reject    genie対象外のコンテナまたはボリュームを一括削除する\n  clean     不要なイメージ・終了済みコンテナ・リンクされてないボリュームを一括削除する\n  build     基本のdockerイメージをビルドする\n  langver   各種言語の利用可能なバージョンを確認する\n  mysql     MySQLを操作する\n  psql      PostgreSQLを操作する\n  open      ブラウザで開く\n  ngrok     \n  logs      実行ログを見る\n  dlsync    \n  httpd     \n  test      \n  demo      デモ\n","  version   バージョン表示\n","warning",1)),process.stdout.write("\n"),console.timeEnd("  Done"),process.stdout.write("\n")})();
},{"./libs.js":3,"./cmd-demo.js":5,"./cmd-config.js":7,"./cmd-ls.js":9,"./cmd-up.js":11,"./cmd-down.js":13,"./cmd-cli.js":15,"./cmd-reject.js":17,"./cmd-clean.js":19,"./cmd-build.js":21,"./cmd-langver.js":23,"./cmd-mysql.js":25,"./cmd-psql.js":27,"./cmd-open.js":29,"./cmd-logs.js":31,"./cmd-test.js":33,"./cmd-version.js":35}]},{},[1])